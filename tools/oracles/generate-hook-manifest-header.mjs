#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';

function argValue(flag, fallback = null) {
  const idx = process.argv.indexOf(flag);
  if (idx === -1 || idx + 1 >= process.argv.length) return fallback;
  return process.argv[idx + 1];
}

function usage() {
  console.log(
    'Usage: node tools/oracles/generate-hook-manifest-header.mjs ' +
    '[--manifest <tok_capture_manifest.v1.json>] [--output <tok_capture_manifest.generated.h>]',
  );
}

function cString(str) {
  return `"${String(str)
    .replace(/\\/g, '\\\\')
    .replace(/"/g, '\\"')
    .replace(/\n/g, '\\n')
    .replace(/\r/g, '\\r')}"`;
}

const repoRoot = process.cwd();
const manifestFile = argValue(
  '--manifest',
  path.join(repoRoot, 'tools/oracles/reference/tok_capture_manifest.v1.json'),
);
const outputFile = argValue(
  '--output',
  path.join(repoRoot, 'tools/oracles/reference/tok_capture_manifest.generated.h'),
);

if (!fs.existsSync(manifestFile)) {
  usage();
  console.error(`Manifest file not found: ${manifestFile}`);
  process.exit(2);
}

const manifest = JSON.parse(fs.readFileSync(manifestFile, 'utf8'));
if (!Array.isArray(manifest.missions)) {
  console.error('Manifest must contain missions[]');
  process.exit(2);
}

const lines = [];
lines.push('// Auto-generated by tools/oracles/generate-hook-manifest-header.mjs');
lines.push('// Do not edit by hand.');
lines.push('#pragma once');
lines.push('');
lines.push('typedef struct TokCaptureMissionEntry {');
lines.push('  const char* script_id;');
lines.push('  int max_tick;');
lines.push('  int frame_count;');
lines.push('  int checkpoint_count;');
lines.push('  const int* checkpoints;');
lines.push('} TokCaptureMissionEntry;');
lines.push('');

for (let i = 0; i < manifest.missions.length; i++) {
  const mission = manifest.missions[i];
  const checkpoints = Array.isArray(mission.checkpointTicks) ? mission.checkpointTicks : [];
  const symbol = `TOK_CAPTURE_CHECKPOINTS_${String(i).padStart(3, '0')}`;
  lines.push(`static const int ${symbol}[] = { ${checkpoints.join(', ')} }; // ${mission.scriptId}`);
}

lines.push('');
lines.push('static const TokCaptureMissionEntry TOK_CAPTURE_MISSIONS[] = {');
for (let i = 0; i < manifest.missions.length; i++) {
  const mission = manifest.missions[i];
  const symbol = `TOK_CAPTURE_CHECKPOINTS_${String(i).padStart(3, '0')}`;
  const frameCount = Number.isFinite(mission.frameCount) ? mission.frameCount : (mission.maxTick + 1);
  const checkpointCount = Array.isArray(mission.checkpointTicks) ? mission.checkpointTicks.length : 0;
  lines.push(
    `  { ${cString(mission.scriptId)}, ${mission.maxTick}, ${frameCount}, ${checkpointCount}, ${symbol} },`,
  );
}
lines.push('};');
lines.push('');
lines.push(`static const int TOK_CAPTURE_MISSION_COUNT = ${manifest.missions.length};`);
lines.push('');

fs.mkdirSync(path.dirname(outputFile), { recursive: true });
fs.writeFileSync(outputFile, `${lines.join('\n')}\n`, 'utf8');
console.log(`Wrote hook manifest header (${manifest.missions.length} missions): ${outputFile}`);
